---
# role for my account
- name: my account is created
  user: name={{user}} shell=/usr/local/bin/zsh

- name: "{{user}} is sudoer"
  lineinfile:
    dest: "/etc/sudoers.d/{{user|replace('.', '_')}}"
    create: yes
    insertafter: EOF
    line: '{{user}}    ALL=(ALL)    NOPASSWD: ALL'

- name: public keys is downloaded
  get_url: url=https://github.com/kawaken.keys dest=/tmp/{{user}}_pubkeys
  delegate_to: localhost

- name: authorized_keys is set up
  authorized_key: user={{user}} key="{{ lookup('file', '/tmp/'+user+'_pubkeys') }}"

- name: repository of dotfiles is cloned
  sudo_user: "{{user}}"
  git: repo="https://github.com/kawaken/dotfiles.git"
    dest=/home/{{user}}/dotfiles
    executable=/usr/local/bin/git

- name: files in dotfiles are symbolic link
  sudo_user: "{{user}}"
  file: src={{item}} dest="/home/{{user}}/{{item|basename|replace('_', '.')}}" state=link
  with_fileglob:
    - /home/{{user}}/dotfiles/_*

- name: projects directory is created
  sudo_user: "{{user}}"
  file: path=/home/{{user}}/projects state=directory

- name: git config is  set up
  sudo_user: "{{user}}"
  command: "git config --global {{item.conf}} '{{item.val}}'"
  with_items:
    - { conf: 'user.name', val: "{{git_username}}" }
    - { conf: 'user.email', val: "{{git_useremail}}" }

- name: xbuild is cloned
  sudo_user: "{{user}}"
  git: repo="https://github.com/tagomoris/xbuild.git"
    dest=/home/{{user}}/xbuild
    executable=/usr/local/bin/git

- name: ruby is installed
  sudo_user: "{{user}}"
  command: xbuild/ruby-install {{ruby_version}} ~/local/ruby-{{ruby_version}}
    creates=/home/{{user}}/ruby-{{ruby_version}}

- name: ruby PATH is set up
  sudo_user: "{{user}}"
  lineinfile: dest=/home/{{user}}/.zshenv insertafter=EOF line="export PATH=$HOME/local/ruby-{{ruby_version}}/bin:$PATH"

- name: python is installed
  sudo_user: "{{user}}"
  command: xbuild/python-install {{python_version}} ~/local/python-{{python_version}}
    creates=/home/{{user}}/python-{{python_version}}

- name: python PATH is set up
  sudo_user: "{{user}}"
  lineinfile: dest=/home/{{user}}/.zshenv insertafter=EOF line="export PATH=$HOME/local/python-{{python_version}}/bin:$PATH"

- name: postgresql PATH is set up
  sudo_user: "{{user}}"
  lineinfile: dest=/home/{{user}}/.zshenv insertafter=EOF line="export PATH=/usr/pgsql-{{postgresql_version}}/bin:$PATH"
